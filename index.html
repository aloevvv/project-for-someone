<!DOCTYPE html>
<html>
<head>
  <title>level editor</title>
  <style>
    body { display: flex; font-family: monospace; }
    #grid { border: 1px solid black; margin-right: 20px; }
    .row { display: flex; }
    .cell {
      width: 40px;
      height: 20px;
      border: 1px solid #aaa;
      cursor: pointer;
    }
    .on { background: #4caf50; }
    #controls { margin-right: 20px; }
    #output {
  white-space: pre; 
  max-height: 200px;      
  overflow-y: auto;
  overflow-x: auto; 
  max-width: 300px;    
  word-wrap: break-word;   
  border: 1px solid #ccc;
  padding: 5px;
}
  </style>
</head>
<body>

<div id="controls">
  <button id="prevPage">Prev</button>
  <button id="nextPage">Next</button>
  <input id="bpm" type="number" value="160" min="20" max="400">
  <br><br>
  <button id="copyPage">Copy Page</button>
  <button id="pastePage">Paste Page</button>
  <br><br>
  <div>Page: <span id="pageLabel">1</span> / 100</div>
  <br><br>
  <button id="downloadCSV">Download CSV</button>
  <button id="uploadCSV">Upload CSV</button>
  <input type="file" id="csvFileInput" accept=".csv" style="display:none">
</div>

<div id="grid"></div>

<div id="output"></div>

<script>
const ROWS = 30;
const COLS = 4;
const PAGES = 100;

let currentPage = 0;

let grid = Array.from({ length: PAGES }, () =>
  Array.from({ length: ROWS }, () => Array(COLS).fill(0))
);

let clipboardPage = null;

const gridDiv = document.getElementById("grid");
const outputDiv = document.getElementById("output");
const pageLabel = document.getElementById("pageLabel");

function buildGrid() {
  gridDiv.innerHTML = "";
  for (let r = 0; r < ROWS; r++) {
    const rowDiv = document.createElement("div");
    rowDiv.className = "row";

    for (let c = 0; c < COLS; c++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.row = r;
      cell.dataset.col = c;

      cell.onclick = () => {
        grid[currentPage][r][c] ^= 1;
        drawGrid();
        updateOutput();
      };

      rowDiv.appendChild(cell);
    }
    gridDiv.appendChild(rowDiv);
  }
}

function drawGrid() {
  const page = grid[currentPage];
  const cells = gridDiv.querySelectorAll(".cell");

  cells.forEach(cell => {
    const r = Number(cell.dataset.row);
    const c = Number(cell.dataset.col);
    cell.classList.toggle("on", page[r][c] === 1);
  });

  pageLabel.textContent = currentPage + 1;
}

let bpm = 160;

document.getElementById("bpm").oninput = e => {
  bpm = Number(e.target.value);
  updateOutput();
};

function updateOutput() {
  let out = [];

  const rowMs = (16 / bpm) * 1000;
  const pageMs = rowMs * ROWS;

  for (let r = 0; r < ROWS; r++) {
    for (let c = 0; c < COLS; c++) {
      if (grid[currentPage][r][c] === 1) {
        const time = Math.round(currentPage * pageMs + r * rowMs);
        out.push(`(${c + 1}, ${time})`);
      }
    }
  }

  outputDiv.textContent = out.join(", ");
}

document.getElementById("prevPage").onclick = () => {
  if (currentPage > 0) {
    currentPage--;
    drawGrid();
    updateOutput();
  }
};

document.getElementById("nextPage").onclick = () => {
  if (currentPage < PAGES - 1) {
    currentPage++;
    drawGrid();
    updateOutput();
  }
};
  
document.getElementById("copyPage").onclick = () => {
  clipboardPage = JSON.parse(JSON.stringify(grid[currentPage]));
};

document.getElementById("pastePage").onclick = () => {
  if (clipboardPage) {
    grid[currentPage] = JSON.parse(JSON.stringify(clipboardPage));
    drawGrid();
    updateOutput();
  }
};

  document.getElementById("downloadCSV").onclick = () => {
  const rowMs = (16 / bpm) * 1000;
  const pageMs = rowMs * ROWS;

  let csv = "lane,time\n";

  for (let p = 0; p < PAGES; p++) {
    for (let r = 0; r < ROWS; r++) {
      for (let c = 0; c < COLS; c++) {
        if (grid[p][r][c] === 1) {
          const time = Math.round(p * pageMs + r * rowMs);
          csv += `${c + 1},${time}\n`;
        }
      }
    }
  }

  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "chart.csv";
  a.click();

  URL.revokeObjectURL(url);
};

document.getElementById("uploadCSV").onclick = () => {
  document.getElementById("csvFileInput").click();
};

document.getElementById("csvFileInput").onchange = e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function(event) {
    const text = event.target.result;
    loadCSVIntoGrid(text);
  };

  reader.readAsText(file);
};

function loadCSVIntoGrid(csvText) {
  grid = Array.from({ length: PAGES }, () =>
    Array.from({ length: ROWS }, () => Array(COLS).fill(0))
  );

  const lines = csvText.trim().split("\n");
  const header = lines.shift();

  const rowMs = (16 / bpm) * 1000;
  const pageMs = rowMs * ROWS;

  for (const line of lines) {
    const [laneStr, timeStr] = line.split(",");
    const lane = Number(laneStr) - 1;
    const time = Number(timeStr);

    const page = Math.floor(time / pageMs);
    const row = Math.floor((time % pageMs) / rowMs);

    if (
      page >= 0 && page < PAGES &&
      row >= 0 && row < ROWS &&
      lane >= 0 && lane < COLS
    ) {
      grid[page][row][lane] = 1;
    }
  }

  drawGrid();
  updateOutput();
}

buildGrid();
drawGrid();
updateOutput();
</script>

</body>
</html>
